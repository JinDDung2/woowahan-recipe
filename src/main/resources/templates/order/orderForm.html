<!DOCTYPE html>

<html lang="ko">
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: headerFragment"/>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
    <title>주문 페이지</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
</head>

<style>

    .main {
        width: 60%;
        min-height: 400px;
        background-color: seashell;
        margin: auto;
    }

    .item-list {
        display: flex;
        flex-direction: row;
    }

    .box {
        margin-top: 35px;
    }

    .content {
        margin-top: 5px;
        margin-left: 25px
    }

    table {
        margin-top: 10px;
        width: 40%;
    }


    .button-container {
        margin-top: 50px;
        height: 50px;
        text-align: center;
    }

    .button {
        margin-left: auto;
        margin-right: auto;
    }
</style>

<body>
<!-- jQuery -->
<script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<!-- iamport.payment.js -->
<script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.1.8.js"></script>
<!-- swal 적용 -->
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

<div th:replace="fragments/bodyHeader :: bodyHeaderFragment"/>
<div class=main>
    <div class="box">
        <h5><b>주문자 정보</b></h5>
        <div class="content">
            <table>
                <tr>
                    <td>이름</td>
                    <td>[[${userResponse.name}]]</td>
                </tr>
                <tr>
                    <td>핸드폰 번호</td>
                    <td>[[${userResponse.phoneNum}]]</td>
                </tr>
                <tr>
                    <td>이메일</td>
                    <td>[[${userResponse.email}]]</td>
                </tr>
            </table>
        </div>
    </div>
    <div class="box">
        <h5><b>배송지 정보</b></h5>
        <div class="content">
            <table>
                <tr>
                    <td>이름</td>
                    <td>[[${userResponse.name}]]</td>
                </tr>
                <tr>
                    <td>핸드폰 번호</td>
                    <td>[[${userResponse.phoneNum}]]</td>
                </tr>
                <tr>
                    <td>주소</td>
                    <td>[[${userResponse.address}]]</td>
                </tr>
            </table>
        </div>
    </div>
    <div class="box">
        <h5><b>주문 정보</b></h5>
        <div class="content">
            <div id="itemName">결제 예정 상품: <span th:text="${item.itemName}"></span></div>
            <div>결제 예정 금액: <span id="cost" th:text="${totalCost}"></span>원</div>
        </div>
    </div>
    <div class="button-container">
        <div class="button">
            <button type="submit" class="btn btn-warning" onclick="requestPay()">결제하기</button>
            <script th:inline="javascript">
                // 결제 금액, 구매자의 이름, 이메일
                function requestPay() {
                    const data = {
                        itemName: [[${item.itemName}]],
                        orderNum: createOrderNum(),
                        totalCost: document.getElementById('cost').innerText,
                        userName: [[${userResponse.name}]],
                        phoneNum: [[${userResponse.phoneNum}]],
                        email: [[${userResponse.email}]],
                        address: [[${userResponse.address}]],
                        itemId: [[${item.itemId}]],
                    }
                    console.log(data.itemName);
                    console.log(data.orderNum);
                    console.log(data.totalCost);
                    console.log([[${userResponse.name}]]);
                    console.log([[${userResponse.phoneNum}]]);
                    console.log([[${userResponse.email}]]);
                    console.log([[${userResponse.address}]]);

                    paymentCard(data);
                }

                function paymentCard(data) {
                    var IMP = window.IMP; // 생략 가능
                    IMP.init("imp78668100");
                    IMP.request_pay({ // param
                        pg: "html5_inicis",
                        pay_method: "card",
                        merchant_uid: data.orderNum,    // 주문번호
                        name: data.itemName,    // 결제창에 보일 상품명
                        amount: data.totalCost,
                        buyer_email: data.email,
                        buyer_name: data.userName,
                        buyer_tel: data.phoneNum,
                        buyer_addr: data.address,
                        // buyer_postcode: data.buyer_postcode
                    }, function (rsp) { // callback
                        if (rsp.success) {
                            // 결제 성공 시 로직,
                            console.log(rsp.imp_uid);
                            data.imp_uid = rsp.imp_uid; // 고유 ID
                            data.merchant_uid = rsp.merchant_uid; // 거래 ID
                            // 결제 성공 시 검증 로직
                            paymentComplete(data);
                        } else {
                            var msg = '결제에 실패하였습니다';
                            console.log(rsp.error_msg);
                            msg += '\n 에러 내용 : ' + rsp.error_msg;
                            alert(msg);
                        }
                    });
                }

                function paymentComplete(data) {
                    $.ajax({
                        url: "/api/v1/orders/payment/complete",
                        method: "POST",
                        contentType: 'application/json',
                        data: JSON.stringify(data),
                    }).done(function () {
                        // 성공시 응답 메세지
                        swal({
                            text: '주문이 완료되었습니다.',
                            closeOnClickOutside: false
                        }) // 에러 메세지 창 닫으면 실행될 함수
                            .then(function () {
                                location.replace("/my")
                            })
                    }).fail(function (result) {
                        var responseText = result.responseText;
                        var message = responseText.split('\"')[13];
                        console.log(message);
                        alert(message);

                        location.replace("/items/" + [[${item.itemId}]] + "/order")
                    })
                }

                function createOrderNum(){
                  const date = new Date();
                  const year = date.getFullYear();
                  const month = String(date.getMonth() + 1).padStart(2, "0");
                  const day = String(date.getDate()).padStart(2, "0");

                  let orderNum = year + month + day;
                  for(let i=0;i<10;i++) {
                    orderNum += Math.floor(Math.random() * 8);
                  }
                  return orderNum;
                }

                function cancel() {
                    alert("주문이 취소되었습니다.");
                    location.replace("/items/" + [[${item.itemId}]])
                }
            </script>
            <button type="submit" class="btn btn-secondary" onclick="cancel()">취소하기</button>
        </div>
    </div>
</div>

<br>

<div th:replace="fragments/footer :: footerFragment"/>

</div>
</body>
</html>